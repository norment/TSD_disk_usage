find $(realpath $1) -not -path "*/sys*" -not -path "*/proc*" -not -path "*/run*" -not -path "*/.snapshots*" -not -path "*/.afm*" -not -path "*/s3-api*" -not -path "/tsd/projects0*/p*/home*" -type d -print0 | xargs -0 -I {} -P $2 sh -c 'dir="$1"; find "$dir" -maxdepth 1 -type f -printf "%u\t%s\n" | awk -v dir="$dir" '"'"'BEGIN {OFS="\t"} {size[$1]+=$2; count[$1]++} END{if (length(size) == 0) print dir, "dir", 0, 0; else for (u in size) print dir, u, size[u], count[u]}'"'"' ' sh {} > disk_report_$(date '+%Y-%m-%d')
ln -sf disk_report_$(date '+%Y-%m-%d') disk_report_latest
